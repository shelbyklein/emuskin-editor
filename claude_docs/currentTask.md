# Current Task

## Current Objectives
- ✅ Implement screen support for game display
- ✅ Add comprehensive IDs to all UI elements
- ✅ Create two-column desktop layout
- ✅ Fix properties panel and drag interactions
- ✅ Implement localStorage persistence for settings
- ✅ Complete export functionality with validation
- ✅ Create import functionality for existing skins
- ✅ Implement custom button creator with multi-action support
- ✅ Add menu insets panel with visual overlay
- ✅ Implement thumbstick support with custom images
- ✅ Add landscape orientation support
- ✅ Fix TypeScript build errors
- ✅ Fix Nintendo DS screen management (prevent deletion)
- ✅ Add thumbstick image storage to IndexedDB
- ✅ Add copy layout between orientations feature
- ✅ Remove auto-save and add manual save button
- ✅ Fix save button functionality - resolved race condition in state management
- ✅ Implement WordPress user account integration - JWT authentication fully implemented
- ✅ Implement lock feature for controls and screens - prevents accidental movement
- ✅ Implement undo/redo functionality - 50-state history with keyboard shortcuts
- ✅ Fix JWT authentication 400 error on reload - removed broken validate endpoint
- ✅ Fix lock button functionality - now properly prevents drag/drop and shows visual feedback
- ✅ Clear screens when console changes - prevents incorrect screen configurations
- ✅ Fix save functionality - replaced buggy autosave with explicit saves on all changes
- ✅ Fix JSON preview to show landscape orientation when available
- Add keyboard shortcuts for common actions

## Context
- Full-featured skin editor with visual control and screen placement
- Screen support implemented with proper inputFrame/outputFrame handling
- Nintendo DS dual-screen support with automatic setup
- Export validation ensures valid skin files
- IndexedDB handles large image storage beyond localStorage limits
- Project management system with save/load/delete functionality
- Grid and snap-to-grid settings persist across sessions
- Extended edges always visible for better usability
- Screens use green theme to distinguish from blue controls

## Recently Fixed Issues
- ✅ Save button not persisting to localStorage
  - Issue: No project existed when navigating directly to /editor
  - Fixed by creating project on first save with all current data
- ✅ Project name and console not saving correctly
  - Issue: Project was created with default values before user input
  - Fixed by updating createProject to accept initial data
- ✅ Save button causing title to revert to default value
  - Issue: useEffect reloading project data after save
  - Fixed by adding isSavingRef to prevent state reset during save
- ✅ Save button not enabling when no project exists
  - Issue: hasUnsavedChanges only tracked when currentProject existed
  - Fixed by removing currentProject check in change tracking
- ✅ Project display not updating after save
  - Issue: When creating new project, the data wasn't fully saved
  - Fixed by calling saveProject again after project creation to ensure all data is saved

## Recent Accomplishments
- ✅ Reorganized UI to display skin title in header with console icon
  - Moved skin title from form section to main header
  - Added console icon display (or placeholder when no console selected)
  - Added edit button next to title to access configuration
  - Created SkinEditPanel component with all configuration options
  - Fixed duplicate ID issues in the layout
- ✅ Fixed property panel trigger behavior - now only opens on settings button click
- ✅ Fixed missing indexedDBManager import error in Editor component
- ✅ Implemented comprehensive touch support for mobile devices:
  - Added touch event handlers for dragging controls and screens
  - Added touch event handlers for resizing elements
  - Fixed passive event listener errors with CSS-based approach
  - Added touch-interactive CSS class to prevent default touch behaviors
  - Enables full functionality on iPads, iPhones, and other touch devices
- ✅ Added comprehensive ID system for all UI elements
- ✅ Implemented two-column desktop layout (info/controls left, canvas/JSON right)
- ✅ Created bottom-sliding properties panel for controls and screens
- ✅ Fixed control properties apply button functionality
- ✅ Prevented properties panel from opening after drag events
- ✅ Made grid more subtle in dark mode
- ✅ Made extended edges always visible on canvas
- ✅ Added localStorage persistence for grid and snap settings
- ✅ Fixed dragging lag when grid snapping is disabled
- ✅ Implemented complete screen support system:
  - Created ScreenMapping type and interfaces
  - Built ScreenPalette for adding screens
  - Built ScreenPropertiesPanel for editing screens
  - Updated Canvas to render/manage screens
  - Added screens to JSON generation and export
  - Automatic screen setup based on console type
  - Special Nintendo DS dual-screen handling
  - Screens persist with projects
- ✅ Fixed resizing performance issues:
  - Added requestAnimationFrame throttling
  - Implemented position refs to avoid state updates
  - Removed CSS transitions during active resize
- ✅ Added settings cog icons to controls and screens
- ✅ Implemented aspect ratio maintenance for screen resizing
- ✅ Created screen alignment panel with immediate positioning
- ✅ Fixed stale closure issues causing position jumping
- ✅ Made settings cog only visible on hover
- ✅ Updated assets format to use object with "medium" key
- ✅ Added "control" class to all control elements
- ✅ Fixed "0" appearing in controls by fixing conditional rendering
- ✅ Made grid size dropdown wider to accommodate caret
- ✅ Fixed console selection by changing to select dropdown
- ✅ Created Home page with project cards view:
  - Displays all saved projects in responsive grid
  - Shows preview images loaded from IndexedDB
  - Includes project metadata and delete functionality
  - Empty state for new users
  - Made Home the default landing page
- ✅ Fixed create new skin button functionality
- ✅ Created import functionality for existing .deltaskin/.gammaskin files:
  - Created ImportButton component with ZIP file parsing
  - Extracts JSON configuration and images from skin files
  - Maps console identifiers to shortnames
  - Converts control and screen data to internal format
  - Handles both standard and edgeToEdge representations
  - Supports portrait orientation (landscape to be added later)
  - Auto-detects device based on mappingSize dimensions
  - Import button available in both Editor and Home pages
  - Imported skins create new projects automatically
- ✅ Completed custom button creator functionality:
  - Added id and label properties to ControlMapping type
  - CustomButtonModal creates controls with unique IDs and custom labels
  - Custom labels display in Canvas (e.g., 'Turbo Fire' instead of 'a+b')
  - All controls now have unique IDs for better tracking
  - ControlPropertiesPanel allows editing custom button labels
  - Multi-button combinations display properly (e.g., 'a+b' for simultaneous press)
  - Custom buttons persist with projects and export correctly
- ✅ Added menu insets panel functionality:
  - Created MenuInsetsPanel component with toggle and slider
  - Bottom value configurable from 0-100% for system UI accommodation
  - Visual overlay shows menu inset area on canvas with transparency
  - JSON structure updated to include menuInsets after extendedEdges
  - Real-time JSON preview updates when adjusting slider
  - Typically used for iPhone home indicator area
- ✅ Implemented comprehensive thumbstick support:
  - Added thumbstick property to ControlMapping interface
  - Thumbsticks support custom PNG image uploads
  - Width and height dimensions configurable (default: 85x87)
  - Images render centered within control bounds
  - Proper JSON structure with thumbstick data before inputs
  - Thumbstick images included in .deltaskin/.gammaskin exports
  - Automatic input mapping to analogStickUp/Down/Left/Right
  - Properties panel opens on thumbstick click for easy configuration
  - Memory management with URL cleanup for blob URLs
- ✅ Created ScreenList component for screen management:
  - Displays existing screens as clickable pills in Game Screens panel
  - Green color theme matches screen elements on canvas
  - Hover state shows delete button with confirmation dialog
  - Click pills to select screen and open properties panel
  - Updated Canvas to support external screen selection
  - Integrated into Editor below ScreenPalette
  - Only shows when screens exist
- ✅ Implemented landscape orientation support:
  - Updated Project interface to store separate portrait/landscape data
  - Added orientation toggle button in Editor header
  - Canvas swaps width/height dimensions when in landscape
  - Each orientation maintains independent control/screen layouts
  - Export includes both orientations in JSON structure
  - Import handles both single and dual-orientation files
  - DeviceInfo shows correct dimensions for current orientation
  - Menu insets and all constraints respect orientation
- ✅ Fixed all TypeScript build errors across components
  - Fixed type issues in Canvas.tsx with ControlMapping vs ScreenMapping
  - Fixed arithmetic operators in ControlPropertiesPanel  
  - Removed all unused imports and variables
  - Clean build for production deployment
- ✅ Fixed Nintendo DS screen management bug
  - DS screens can no longer be deleted
  - Visual indicator shows DS screens are required
  - Alert prevents deletion attempts
  - Improved DS screen initialization logic
- ✅ Verified thumbstick image persistence to IndexedDB
  - System was already properly implemented
  - Images save when uploaded and load when project opens
- ✅ Added copy layout between orientations feature
  - New button next to orientation toggle
  - Copies controls, screens, settings between portrait/landscape
  - Maintains control IDs for thumbstick associations
  - Includes confirmation dialog
- ✅ Fixed infinite loop in portrait orientation data
  - Memoized all functions in ProjectContext with useCallback
  - saveProject, saveOrientationData, getOrientationData, getCurrentOrientation, setOrientation, saveProjectImage
  - Prevents functions from being recreated on every render
  - Fixes the auto-save useEffect dependency issue
- ✅ Fixed canvas element position jump issue
  - Removed auto-save functionality completely
  - Added manual save button with visual feedback
  - Added Cmd/Ctrl+S keyboard shortcut for quick saving
  - Simplified state management and removed race conditions
- ✅ Fixed save button race condition bug
  - Race condition was causing skin name/identifier updates to not persist when saving
  - Removed setTimeout approach in handleSave for new project creation
  - Added isSavingRef flag to prevent state overwrites during save operations
  - Enhanced project loading useEffect to skip updates when saving is in progress
  - Fixed change tracking to not trigger false unsaved flags during save process
  - New skin names and identifiers now persist correctly after saving
- ✅ Fixed edit panel auto-opening bug
  - Edit panel was opening every time user loaded a project created via "new-project-button"
  - Projects created with new-project-button remained in "unconfigured" state permanently
  - Added hasBeenConfigured flag to Project interface to track configuration status
  - Modified edit panel logic to use hasBeenConfigured instead of checking for null console/device
  - Projects are marked as configured when both console and device are set via SkinEditPanel
  - Removed hasShownEditPanelRef reset on component unmount to persist across navigation
  - Added backward compatibility migration for existing projects
  - Edit panel now only shows once per unconfigured project, not on every load
- ✅ Fixed SkinEditPanel "Save Settings" button not persisting data
  - SkinEditPanel callbacks were only updating local state, not saving to localStorage
  - Modified onSkinNameChange and onSkinIdentifierChange to call saveProject immediately
  - Updated onConsoleChange and onDeviceChange to save full console/device objects to project
  - Added proper lookup of console/device data objects from dropdown selections
  - All skin settings (name, identifier, console, device) now persist correctly when "Save Settings" is clicked
  - Projects are automatically marked as configured when both console and device are selected
- ✅ Implemented WordPress authentication foundation
  - Created AuthContext for user state management with WordPress integration
  - Added user ownership fields to Project interface (userId, isPublic, createdAt)
  - Built AuthButton component for login/logout functionality
  - Created AuthCallback page for OAuth flow handling
  - Added authentication route and integrated AuthProvider into app structure
  - Created comprehensive API utilities for backend communication (projects, auth, images)
  - Implemented mock authentication system for development
  - All components ready for WordPress JWT integration once backend is deployed
- ✅ Switched from OAuth to JWT authentication for simplicity and cost
  - Replaced miniOrange OAuth with Simple JWT Login plugin (free)
  - Fixed API endpoint URLs to use ?rest_route= format (WordPress configuration)
  - Implemented JWT decoding to extract user data directly from token
  - Updated login flow to use email/password with modal interface
  - Removed OAuth callback page and related complexity
  - Authentication now works with sklein91@gmail.com credentials
  - Fixed "Authentication is not enabled" error by using correct email parameter
  - All OAuth-related code cleaned up and removed
- ✅ Implemented user authentication gate on Home page
  - Non-authenticated users see login prompt with benefits list
  - Authenticated users see their projects and profile section
  - Projects are filtered to show only current user's projects
  - Legacy projects without userId are still shown to maintain backward compatibility
  - ProjectContext automatically assigns userId to new projects
  - Added createdAt timestamp to track project creation
  - Added AuthButton to mobile menu for mobile authentication
  - All created skins are now tied to user accounts
- ✅ Implemented lock feature for controls and screens
  - Added locked boolean property to ControlMapping and ScreenMapping types
  - Lock button appears in hover menu as yellow circle with lock/unlock icon
  - Locked items cannot be moved or resized but can still be selected
  - Prevents accidental movement of carefully positioned elements
  - Lock state persists with project saves
  - Visual cursor feedback shows when items are locked (default cursor instead of move)
  - Works for both controls and screens independently
- ✅ Implemented undo/redo functionality
  - Created 50-state history stack tracking all control and screen changes
  - Keyboard shortcuts: Cmd/Ctrl+Z for undo, Cmd/Ctrl+Shift+Z for redo
  - Visual undo/redo buttons added to canvas toolbar with hover tooltips
  - Buttons show disabled state when no more actions to undo/redo
  - History tracks add, delete, move, resize, and property changes
  - History initializes when loading projects
  - Debounced history pushes to avoid excessive entries
  - Memory-efficient implementation with automatic cleanup
- ✅ Fixed JWT authentication 400 error
  - Removed problematic API call to Simple JWT Login's validate endpoint
  - Implemented local JWT validation by decoding token client-side
  - Check token expiration and extract user data from payload
  - Authentication now persists correctly across page reloads
  - Better error handling and logging for auth issues
- ✅ Fixed lock button functionality
  - Controls were checking wrong variable (isLocked instead of control.locked)
  - Added proper lock checks to prevent drag/drop event handlers
  - Implemented visual feedback: purple for locked controls, gray for locked screens
  - Resize handles now properly hide when elements are locked
  - Cursor shows 'default' instead of 'move' for locked elements
- ✅ Clear screens when changing console type
  - Screens now automatically clear when switching consoles
  - Nintendo DS automatically creates two required screens
  - Prevents screen configurations from persisting across incompatible consoles
  - Added history tracking for console changes
- ✅ Fixed save functionality issues
  - Removed constantly-running autosave that was causing performance problems
  - Added explicit saves after every user action (add/update/delete controls or screens)
  - Fixed autosave cleanup effect dependencies to prevent stale closures
  - Added comprehensive debug logging to track save operations
  - All changes now save immediately without relying on timers
- ✅ Fixed JSON preview to show landscape orientation
  - JsonPreview component was hardcoded to only show portrait data
  - Added useProject hook to access project context and orientation data
  - Updated JSON generation to include both portrait and landscape when available
  - Mirrors the same structure as ExportButton for consistency
  - JSON preview now dynamically shows all available orientations
- ✅ Implemented user database for tracking users and projects
  - Created userDatabase utility with structure: email -> { loginCount, projects: [...] }
  - Tracks user logins, first/last login times, and project ownership
  - AuthContext records logins and runs migration for existing projects
  - ProjectContext adds/removes projects from user database on create/delete
  - Home page now filters projects based on user database array
  - Added DatabaseDebugger component to visualize database structure
  - User database serves as single source of truth for project ownership
- ✅ Updated R2 storage structure to organize by user email
  - Changed from: projects/[id]/[type]/[orientation]/[timestamp]-[file]
  - Changed to: [email]/[project]/[orientation].png
  - Thumbsticks: [email]/[project]/thumbstick-[controlId].png
  - Updated Cloudflare worker to use simplified paths
  - Modified r2Client to pass user email with all uploads
  - Added authentication check before allowing uploads
  - Removed timestamps for cleaner URLs and automatic replacement
- ✅ Improved OrientationManager UI and accessibility
  - Added comprehensive IDs to all child elements for better testability
  - Made orientation buttons full width with borders for clearer visual separation
  - Moved content indicator dot to the right side of buttons
  - Implemented hover effect: dot fades out and remove button (X) appears in same position
  - Fixed positioning issues ensuring dot and X overlay perfectly
  - Enhanced visual feedback with smooth opacity transitions
- ✅ Reorganized editor UI layout for better workflow
  - Reordered left column: Game Screens, Available Controls, Image Upload, Menu Insets
  - Moved OrientationManager from left column to canvas toolbar
  - Updated OrientationManager to horizontal layout for toolbar placement
  - Changed control palette from flexbox to 4-column grid layout
  - Updated control buttons to use aspect-square instead of fixed dimensions
- ✅ Enhanced OrientationManager visual design
  - Replaced text pills with visual representations of portrait (9:16) and landscape (16:9)
  - Icons now properly reflect aspect ratios with reduced size (30% smaller)
  - Added borders and consistent pill height (64px) for better visual hierarchy
  - Moved delete button to top-right corner of pill (not on icon)
  - Green dot indicator shows when orientation has content
  - Purple "Add Portrait/Landscape" buttons match the visual style
  - Fixed DOM nesting error (button inside button) by restructuring component
- ✅ Moved GridControls to canvas toolbar
  - Grid options (Show Grid, Snap to Grid, Grid Size) now integrated into canvas toolbar
  - Better organization with grid controls between undo/redo and orientation manager
  - Removed redundant placement below the toolbar
- ✅ Deployed Cloudflare Worker with user-based storage structure
  - R2 storage now correctly uses [email]/[project]/[orientation].png format
  - All new uploads will be organized by user email
- ✅ Added logout redirect to home page
  - When users log out, they are automatically redirected to the home page
  - Implemented using React Router navigation in AuthButton component
  - AuthContext logout function now accepts optional callback for post-logout actions
- ✅ Fixed grid size dropdown text color in dark mode
  - Added proper text color classes (text-gray-900 dark:text-gray-100)
  - Grid size options now properly visible in both light and dark themes
- ✅ Implemented template selection feature
  - Created /public/assets/templates/ directory with 8 console templates
  - Added "Start with a template:" section to home page for authenticated users
  - Each template includes pre-configured control layouts and screen positions
  - Templates load automatically when selected, navigating to editor with data
  - Quick start workflow significantly improves new user experience
- ✅ Fixed menu insets not appearing in JSON preview
  - Issue: Menu insets changes were only updating local state, not project context
  - Updated MenuInsetsPanel callbacks to save changes via saveOrientationData
  - Menu insets now persist to project and appear correctly in JSON output
  - Follows same pattern as controls/screens with immediate saves on change
- ✅ Implemented keyboard shortcuts for navigation and positioning
  - Created useKeyboardShortcuts hook for centralized shortcut management
  - Arrow keys: Nudge selected control/screen by 1px
  - Shift+Arrow keys: Nudge by 10px for faster positioning
  - Escape: Deselect current item and close properties panels
  - Tab/Shift+Tab: Cycle through controls with wrapping
  - Delete/Backspace: Delete selected control/screen (enhanced with new system)
  - Shortcuts disabled in input fields
  - Locked items cannot be nudged
  - Updated tooltips to show keyboard shortcuts
  - All changes saved automatically with history tracking
- ✅ Implemented toast notification system
  - Created Toast component with auto-dismiss (3 seconds default)
  - Four types: success, error, warning, info with icons
  - ToastContext for global notification management
  - Smooth slide animations and dark mode support
  - Replaced all 11 alert() calls throughout the application
  - Non-blocking notifications can stack multiple messages
  - Close button for manual dismissal
  - Accessible with ARIA live regions
- ✅ Moved Import/Export buttons to editor header
  - Import and Export buttons now located in the header next to project manager
  - Updated to icon-only format matching save/open project buttons
  - Import: cloud upload icon with tooltip
  - Export: download icon with dropdown for format selection
  - Maintains all existing functionality while improving UI consistency
- ✅ Updated UI components with custom SVG icons
  - Import/Export buttons now use custom SVG icons from assets folder
  - Buttons positioned on right side of header with divider separator
  - Export button simplified to single icon with dropdown on click
- ✅ Enhanced ScreenPropertiesPanel with icon-based alignment buttons
  - Replaced text labels with SVG icons for all alignment actions
  - Icons: scale, align-left/right/top/bottom, center-horizontal/vertical
  - Grey button backgrounds with hover states for consistency
  - Scale button spans two rows for visual hierarchy
  - Input frame info moved to tooltip on hover of info icon
- ✅ Fixed device selection to match skin dimensions on load
  - Created helper function to find device by dimensions
  - Projects now auto-select correct device based on mappingSize
  - Toast notification shows when device is changed
  - Prevents skins from always loading at iPhone 16 Pro Max size
- ✅ Fixed template visibility for new users
  - Templates now show for all authenticated users
  - Moved template section outside userProjects.length condition
  - New users see templates immediately after signing in
  - Empty state message updated to reference templates
- ✅ Implemented skin testing feature
  - Added "Test" button to project cards on home page
  - Created fullscreen TestSkin component for interactive testing
  - Visual feedback shows controls being pressed (opacity/scale changes)
  - Active button display shows pressed buttons on game screen
  - Support for multi-touch and simultaneous button presses
  - Fullscreen mode support with toggle button
  - Orientation switching for projects with both layouts
  - Exit button and project info display
- ✅ Fixed missing save button when starting with template
  - Issue: Race condition where navigation happened before project was fully loaded
  - Solution: Added await loadProject() after createProject() in handleTemplateSelect
  - Save button now appears correctly when starting with a template
- ✅ Fixed controls disappearing after saving template-based projects
  - Issue: handleSave was missing menuInsetsLeft and menuInsetsRight in orientation data
  - Also missing saveOrientationData dependency in template loading effect
  - Solution: Added all menu inset values to save data and fixed dependency array
  - Controls now persist correctly after saving
- ✅ Fixed TestSkin component crash when clicking "Test" button
  - Issue: TypeError trying to access screen.frame.x when screens use outputFrame
  - Solution: Updated screen rendering to use screen.outputFrame instead of screen.frame
  - Added filter to ensure only screens with valid outputFrame are rendered
  - Test mode now works correctly without errors
- ✅ Moved button press display to game screen area
  - Changed from displaying at top of canvas to inside the first game screen
  - Position is relative to screen boundaries with 8px padding
  - Smaller badges with reduced padding for better fit in screen
  - Only displays when screens exist and buttons are pressed
  - Max width constraint prevents badges from extending outside screen
- ✅ Implemented cloud sync capability for cross-device project access
  - Integrated projectsAPI into ProjectContext
  - Projects load from cloud API on user login
  - All CRUD operations sync to cloud when API is available
  - Added VITE_API_URL environment check
  - Graceful fallback to localStorage when offline
  - Warning message shows when API not configured
  - Ready for backend deployment
- ✅ Created backend API for project synchronization
  - Express.js server with MongoDB database
  - JWT authentication validates WordPress tokens
  - Full CRUD endpoints matching frontend expectations
  - Deployment configs for multiple platforms
  - Ready to deploy - just needs MongoDB and hosting
- ✅ Prepared API for Vercel deployment with DigitalOcean MongoDB
  - Created comprehensive DEPLOYMENT.md guide
  - Added MongoDB connection test script
  - Setup script for quick initialization
  - Optimized vercel.json for production
  - Helper NPM scripts for easy deployment

## Current Issues
- ✅ Fixed API availability detection
  - App now gracefully handles missing MongoDB configuration
  - Shows appropriate error messages in development
  - ProjectContextV3 is the correct context (API-only)
  - No local storage fallback - database is required

## Deployment in Progress
- ✅ Fixed Vercel deployment configuration errors
  - Removed deprecated `builds` property conflicting with `functions`
  - Created proper serverless function structure at api/serverless.js
  - Added buildCommand: "" to prevent Vite build errors
  - Created .vercelignore to exclude unnecessary files
  - Ready to deploy as separate API project

## Recent Fixes
- ✅ Fixed "builds and functions cannot be used together" error
  - Migrated from deprecated builds to modern rewrites format
  - Kept functions property for serverless configuration
- ✅ Fixed "pattern doesn't match Serverless Functions" error
  - Created api/serverless.js as proper entry point
  - Updated vercel.json to point to correct function path
- ✅ Fixed "vite build exited with 127" error
  - Added buildCommand: "" to prevent frontend build
  - Added outputDirectory: "." for API-only deployment

## Next Steps
1. Run `vercel link` to create new API project
2. Deploy with `npm run deploy`
3. Set up DigitalOcean MongoDB
4. Configure environment variables
